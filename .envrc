# direnv configuration for ESP32 Soil Sensor project
# Automatically sets up Python virtual environment with PlatformIO

# Configuration
VENV_DIR=".venv"
PROJECT_ROOT=$(pwd)

# Color output for messages
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Find Python 3.13 (required for PlatformIO compatibility)
# Note: System python3 is 3.14.2 which is too new for PlatformIO
if command -v python3.13 >/dev/null 2>&1; then
    PYTHON_CMD="python3.13"
else
    echo -e "${RED}ERROR: Python 3.13 not found in PATH${NC}"
    echo -e "${YELLOW}PlatformIO requires Python 3.10-3.13 (system has 3.14.2 which is too new)${NC}"
    echo -e "${YELLOW}Please install Python 3.13: sudo dnf install python3.13${NC}"
    return 1
fi

# Create virtual environment if it doesn't exist
if [ ! -d "$VENV_DIR" ]; then
    echo -e "${YELLOW}Creating Python virtual environment...${NC}"
    $PYTHON_CMD -m venv "$VENV_DIR"

    if [ $? -ne 0 ]; then
        echo -e "${RED}ERROR: Failed to create virtual environment${NC}"
        return 1
    fi

    echo -e "${YELLOW}Installing PlatformIO and dependencies...${NC}"
    echo -e "${YELLOW}This may take a few minutes on first setup...${NC}"

    # Upgrade pip and install base packages
    "$VENV_DIR/bin/pip" install --upgrade pip setuptools wheel --quiet

    # Install PlatformIO
    "$VENV_DIR/bin/pip" install platformio --quiet

    if [ $? -ne 0 ]; then
        echo -e "${RED}ERROR: Failed to install PlatformIO${NC}"
        echo -e "${YELLOW}Try removing $VENV_DIR and running 'direnv allow' again${NC}"
        return 1
    fi

    echo -e "${GREEN}Virtual environment created successfully!${NC}"
else
    # Verify PlatformIO is installed
    if [ ! -f "$VENV_DIR/bin/pio" ]; then
        echo -e "${YELLOW}PlatformIO not found in venv, installing...${NC}"
        "$VENV_DIR/bin/pip" install --upgrade pip setuptools wheel platformio --quiet
    fi
fi

# Activate virtual environment
source "$VENV_DIR/bin/activate"

# Export environment variables
export VIRTUAL_ENV="$PROJECT_ROOT/$VENV_DIR"
export PATH="$PROJECT_ROOT/$VENV_DIR/bin:$PATH"

# Verify PlatformIO is available
if command -v pio >/dev/null 2>&1; then
    PIO_VERSION=$(pio --version 2>/dev/null | head -n1)
    echo -e "${GREEN}ESP32 Soil Sensor - Development Environment Ready${NC}"
    echo -e "  PlatformIO: ${PIO_VERSION}"
    echo -e "  Python: $($PYTHON_CMD --version | cut -d' ' -f2)"
    echo -e ""
    echo -e "Run ${GREEN}make help${NC} to see available build commands"
else
    echo -e "${RED}WARNING: PlatformIO not found in PATH${NC}"
    echo -e "${YELLOW}Try: direnv reload${NC}"
fi
